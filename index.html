<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rain</title>
    <style>
    body {
        margin: 0;
        background: #000;
    }

    #root {
        position: absolute;
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #canvas {
        width: 100%;
        height: 100%;
    }

    #loading {
        position: absolute;
        z-index: -1;
        font-family: 'Segoe UI', Roboto, Tahoma, Geneva, Verdana, sans-serif;
        font-size: 2em;
        color: gray;
    }
    </style>
    <script src="./script.js"></script>
</head>

<body>
    <div id="root">
        <div id="bg-controls" style="position:absolute;top:10px;right:-50;z-index:10;display:flex;gap:8px;align-items:center;background:rgba(0, 0, 0, 0);border-radius:16px; display:none;">
            <div style="position:relative; height: 28px;"> <!-- กำหนด height ที่นี่ -->
                <input 
                    id="bg-input" 
                    type="url" 
                    placeholder="Paste URL or drop image" 
                    style="height: 100%; padding: 0 10px; border-radius:8px; border:1px; outline:none; min-width:220px; font-size:1rem; box-sizing: border-box;" 
                />
                <input 
                    id="bg-file" 
                    type="file" 
                    accept="image/*" 
                    style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;" 
                />
            </div>

            <button id="rain-btn" type="button" style="height: 28px; padding:0 16px; border-radius:8px; background:#62b1ff; color:#f8f8f8; font-weight:500; transition:background 0.2s; border:none; cursor:pointer;">Rain!</button> 
        </div>
        <canvas id="canvas"></canvas>
        <p id="loading">Loading...</p>
    </div>
    <script>
        const canvas = document.querySelector("#canvas");
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;

        // ฟังก์ชันสำหรับสุ่มลิงก์รูปใหม่จาก picsum.photos
        // function getRandomImageUrl() {
        //     return "https://picsum.photos/300/300?random=" + Math.random();
        // }

        function getRandomImageUrl(category = "nature") {
            const sources = [
                () => 'https://picsum.photos/300/300?random=${Math.random()}',
            ];
            return sources[Math.floor(Math.random() * sources.length)]();
        }

        // ใช้รูปสุ่มทันทีตอนโหลดหน้า

        // dummy image (1x1 transparent PNG)
        const DUMMY_IMAGE =
            'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/w8AAn8B9p6Q2wAAAABJRU5ErkJggg==';

        async function loadImageOrDummy(url) {
            return new Promise(resolve => {
                const img = new window.Image();
                img.onload = () => resolve(url);
                img.onerror = () => resolve(DUMMY_IMAGE);
                img.src = url;
            });
        }

        (async function() {
            let currentBg = getRandomImageUrl();
            currentBg = await loadImageOrDummy(currentBg);
            let raindropFx = new RaindropFX({
                canvas: canvas,
                background: currentBg,
            });
            raindropFx.start();
            window.raindropFx = raindropFx;
            canvas.style.filter = "brightness(0.8) contrast(1.1) saturate(0.9)";
        })();

        // Modern floating controls
        const bgInput = document.getElementById('bg-input');
        const bgFileInput = document.getElementById('bg-file');
        const bgControls = document.getElementById('bg-controls');
        const rainBtn = document.getElementById('rain-btn');

        // --- Auto hide controls on user activity ---
        let hideTimeout;
        let isHidden = false;
        const HIDE_DELAY = 5000; // ms

        function showControls() {
            if (isHidden) {
                bgControls.style.opacity = '1';
                bgControls.style.pointerEvents = '';
                isHidden = false;
            }
        }

        function hideControls() {
            bgControls.style.opacity = '0';
            bgControls.style.pointerEvents = 'none';
            isHidden = true;
        }

        function resetHideTimer() {
            showControls();
            clearTimeout(hideTimeout);
            hideTimeout = setTimeout(hideControls, HIDE_DELAY);
        }

        // Listen for user activity
        ['mousemove', 'touchstart', 'keydown', 'mousedown'].forEach(evt => {
            window.addEventListener(evt, resetHideTimer, {passive:true});
        });

        // Start timer on load
        resetHideTimer();

        // Rain! button สุ่มรูปใหม่จาก picsum.photos ทุกครั้งที่กด
        rainBtn.addEventListener('click', function() {
            const randomBg = getRandomImageUrl();
            setCustomBackground(randomBg, randomBg);
            resetHideTimer(); // show controls if hidden
        });

        // Handle URL input
        bgInput.addEventListener('change', function() {
            if (bgInput.value) {
                setCustomBackground(bgInput.value, bgInput.value);
            }
        });

        // Handle file selection
        bgFileInput.addEventListener('change', function() {
            const file = bgFileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    setCustomBackground(e.target.result, file.name);
                };
                reader.readAsDataURL(file);
            }
        });

        // Drag & drop support for url or file
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            // Clear input
            bgInput.value = '';
            bgFileInput.value = '';
            // File dropped
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        setCustomBackground(ev.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                }
                return;
            }
            // URL dropped
            const url = e.dataTransfer.getData('URL') || e.dataTransfer.getData('text/plain');
            if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                bgInput.value = url;
                setCustomBackground(url, url);
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Attach to canvas and controls
        [canvas, bgControls].forEach(el => {
            el.addEventListener('dragover', handleDragOver);
            el.addEventListener('drop', handleDrop);
        });

        function setCustomBackground(bg, label) {
            raindropFx.setBackground(bg);
            if (label) {
                bgInput.value = label;
            }
        }

        // Clicking the input field opens file dialog if empty
        bgInput.addEventListener('click', function() {
            if (!bgInput.value) {
                bgFileInput.click();
            }
        });
    </script>
</body>


</html>


